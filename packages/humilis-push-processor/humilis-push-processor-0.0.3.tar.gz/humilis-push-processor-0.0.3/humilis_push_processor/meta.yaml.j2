---
# Hyperparameters to this layer:
#
# input, output, error
# input_delivery, output_delivery, error_delivery
# lambda_dependencies
meta:
    description:
        Processes events in a Kinesis stream
    parameters:
        dynamodb_capacity:
            description:
                The read and write capacity for the Lambda state table(s)
            value:
                read: 1
                write: 1

        batch_size:
            description:
                The number of events to batch in one lambda execution
            value: 1

        lambda_dependencies:
            description:
                A list of Python dependencies for the Lambda function
            value: []

        sources:
            description:
                The AWS services that may push events to the Lambda
            value:
                - sns
                - s3

        {% if input %}
        meta_input:
            description: Mapping and filtering for the input events
            value:
                mapper: "{{input.mapper}}"
                filter: "{{input.filter}}"
        {% endif %}

        # Settings for the error Kinesis stream
        {% if error %}
        meta_error:
            description:
                Settings for the error event stream
            value:
                {% if error.kinesis_stream %}
                kinesis_stream:
                    ref:
                        parser: output
                        parameters:
                            layer_name: {{error.kinesis_stream.layer}}
                            output_name: {{error.kinesis_stream.name}}
                kinesis_stream_arn:
                    ref:
                        parser: output
                        parameters:
                            layer_name: {{error.kinesis_stream.layer}}
                            output_name: {{error.kinesis_stream.name}}Arn
                {% endif %}

                {% if error.firehose_delivery_stream %}
                firehose_delivery_stream:
                    ref:
                        parser: output
                        parameters:
                            layer_name: {{error.firehose_delivery_stream.layer}}
                            output_name: {{error.firehose_delivery_stream.name}}
                firehose_delivery_stream_arn:
                    ref:
                        parser: output
                        parameters:
                            layer_name: {{error.firehose_delivery_stream.layer}}
                            output_name: {{error.firehose_delivery_stream.name}}Arn
                {% endif %}
                mapper: "{{error.mapper}}"
                filter: "{{error.filter}}"
        {% endif %}

        # There can be 0 or more output streams
        {% if output %}
        meta_output:
            description:
                Settings for the output event stream(s)
            value:
                {% for s in output %}
                -
                  {% if s.kinesis_stream %}
                  kinesis_stream:
                      ref:
                          parser: output
                          parameters:
                              layer_name: {{s.kinesis_stream.layer}}
                              output_name: {{s.kinesis_stream.name}}
                  kinesis_stream_arn:
                      ref:
                          parser: output
                          parameters:
                              layer_name: {{s.kinesis_stream.layer}}
                              output_name: {{s.kinesis_stream.name}}Arn
                  {% endif %}

                  {% if s.firehose_delivery_stream %}
                  firehose_delivery_stream:
                      ref:
                          parser: output
                          parameters:
                              layer_name: {{s.firehose_delivery_stream.layer}}
                              output_name: {{s.firehose_delivery_stream.name}}
                  firehose_delivery_stream_arn:
                      ref:
                          parser: output
                          parameters:
                              layer_name: {{s.firehose_delivery_stream.layer}}
                              output_name: {{s.firehose_delivery_stream.name}}Arn
                  {% endif %}

                  mapper: {{s.mapper}}
                  filter: {{s.filter}}
                  partition_key: {{s.partition_key}}
                {% endfor %}
        {% endif %}

        lambda_function:
            # We use a low priority so that the references above that retrieve
            # the names of the relevant streams are resolved before this
            # reference.
            priority: 100
            value:
                ref:
                    parser: lambda
                    parameters:
                        path: lambda_function
                        dependencies: {{lambda_dependencies or []}}
